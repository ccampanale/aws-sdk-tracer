# aws-sdk-tracer

This is a library intended to be used to instrument the [AWS NodeJS SDK](https://github.com/aws/aws-sdk-js) by wrapping the library and tracing calls made to the AWS API.

## Context

Traces are collected in memory and can be manually printed and/or retrieved. Additionally, there are built-in exporters which provide means for exporting the collected trace data.

The primary goal of this tracing is to facilitate developer knowledge of AWS service actions and resources used during development in order to generate tightly scoped policies for components deployed into an AWS account. This can be done by specifying the `filesystem` exporter when wrapping the AWS SDK. This exporter will maintain a temporary file with data regarding the utilization of the SDK during runtime and between executions. At any point this file can be provided to a command line script `gen-policy [<path>]` (where `<path>` is the path to the exported file which be default is `/tmp/aws-sdk-tracer.json`) which will attempt to parse the contents and generate an AWS Policy Document with statements pertaining to how each service is used.

**Note:** Policies generated by this library are very simplistic and not necessarily intended to be used as-is. Rather, the expectation is that these policy documents can be used as a jump-off point for determining how to scope the policies for your component once deployed. All statements generated will in effect "Allow" the actions which were traced.

## Usage

The quickest way to get started is to simply load the library and `aws-sdk` together:

```js
const {AWS, wrapper} = require('aws-sdk-tracer').wrapAWSSDK(require('aws-sdk')); 

// ... after creating and using AWS services ...

wrapper.printUtilization();
```

Since no exporters were specified, all trace data is in memory so `wrapper.printUtilization()` is used to print the utilization data.

The wrapper also supports options for console logging trace events for each request sent as well as specifying various exporters.

```js
const AWSSDKTracer = require('aws-sdk-tracer');

const wrapperOpts = {
    logger: console,
    exporters: [
        'filesystem',
    ]
};

const {AWS, wrapper} = AWSSDKTracer.wrapAWSSDK(require('aws-sdk'), wrapperOpts); 
```

**Note:** You do not need to use the AWS SDK as returned by the wrapper as the library itself is effectively wrapped.

```js
const AWSSDKTracer = require('aws-sdk-tracer');
const AWS = require('aws-sdk');

const wrapperOpts = {
    logger: console,
    exporters: [
        'filesystem',
    ]
};

AWSSDKTracer.wrapAWSSDK(AWS, wrapperOpts); 

const ECS = new AWS.ECS();

// ... etc.

```

## Todo

There is a lot more that can be done; this is only touching the surface.

  - finish implementation of HTTP exporter
    - the goal of this exporter would be for private utilization telemetry data
  - better/more tests
  - better options and configurability of wrapper and other components
